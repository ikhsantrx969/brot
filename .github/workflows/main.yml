name: VPS KVM Ultimate (Manual Tailscale)
on: 
  workflow_dispatch:

jobs:
  run-vps-kvm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. Cek Secret (Biar tenang hati)
      - name: Cek Secret Tailscale
        run: |
          if [ -z "${{ secrets.TAILSCALE_AUTHKEY }}" ]; then
            echo "‚ùå BAHAYA: Secret TAILSCALE_AUTHKEY kosong!"
            exit 1
          else
            echo "‚úÖ AMAN: Secret ditemukan."
          fi

      # 2. Login GHCR (Biar bisa tarik image lu)
      - name: Login ke GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # 3. Setup KVM (Permission)
      - name: Setup Permission KVM
        run: |
          echo "Memperbaiki izin /dev/kvm..."
          sudo chmod 666 /dev/kvm
          ls -la /dev/kvm

      # 4. Install Tailscale MANUAL (Anti Error Version)
      - name: Install & Connect Tailscale
        run: |
          # Download Script Resmi
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Start Service di Background (Userspace Mode biar aman di GHA)
          sudo tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          
          # Tunggu service bangun tidur
          echo "Menunggu Tailscale service..."
          sleep 5
          
          # Connect pakai Secret
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --ssh --hostname gh-kvm-box

      # 5. Jalankan Docker Container (KVM ON)
      - name: Start Docker Container
        run: |
          echo "Menjalankan Container..."
          
          # Jalankan di background (-d)
          docker run -d \
            --name my_kvm_machine \
            --device /dev/kvm \
            --privileged \
            -e RAM=7000 \
            -e CPU=2 \
            ghcr.io/ikhsantrx969/ubuntuos:latest \
            tail -f /dev/null 
            # 'tail -f' dipake biar container gak mati sendiri

      # 6. Loop (Biar GHA gak mati selama 6 jam)
      - name: VPS SIAP DIGUNAKAN!
        run: |
          echo "=========================================="
          echo "‚úÖ STATUS: BERHASIL!"
          echo "üì± CARA KONEK DARI TERMUX:"
          echo "   1. ssh runner@gh-kvm-box"
          echo "   2. (Setelah masuk) ketik: docker exec -it my_kvm_machine bash"
          echo "=========================================="
          echo "‚è≥ Menjaga koneksi tetap hidup selama 6 jam..."
          sleep 21600
