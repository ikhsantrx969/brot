name: Ubuntu 20.18 Datacenter VPS
on: 
  workflow_dispatch:

jobs:
  datacenter-instance:
    runs-on: ubuntu-20.18
    steps:
      - name: 1. Setup Environment (Clean & Tune)
        run: |
          # --- Cleaning ---
          # Menghapus software bawaan runner agar lebih ringan
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell
          sudo rm -f /etc/update-motd.d/*
          sudo touch /etc/update-motd.d/00-header
          
          # --- Timezone & Hostname ---
          sudo timedatectl set-timezone Asia/Jakarta
          sudo hostnamectl set-hostname "ubuntu-datacenter-2004"
          
          # --- Kernel Optimization ---
          # Mengaktifkan BBR (Tersedia di Kernel 4.9+ jadi aman untuk Ubuntu 20.04)
          echo "net.core.default_qdisc=fq" | sudo tee -a /etc/sysctl.conf
          echo "net.ipv4.tcp_congestion_control=bbr" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p

      - name: 2. Install Tools & SSH Config
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y htop nano neofetch tmux net-tools openssh-server
          
          # --- SSH & User Config ---
          echo "root:${{ secrets.SSH_PASSWORD }}" | sudo chpasswd
          
          # Setup PS1 (Tampilan Terminal)
          cat <<EOF | sudo tee /root/.bashrc
          export TERM=xterm-256color
          export PS1='\[\033[01;31m\]root@ubuntu-datacenter-2004\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]# '
          alias ll='ls -alF'
          alias cls='clear'
          neofetch
          EOF
          
          # Izinkan Root Login (Config SSH 20.04)
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh restart

      - name: 3. Deploy Tunnel & Start Session
        run: |
          # --- Install Cloudflared ---
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
          # --- Run Tunnel (Background) ---
          # 'nohup' wajib agar tunnel tidak mati saat pindah baris
          nohup sudo cloudflared tunnel --no-autoupdate run --token ${{ secrets.CLOUDFLARE_TOKEN }} --protocol quic > /dev/null 2>&1 &
          
          sleep 10
          
          # --- Tampilkan Info ---
          echo "=============================================="
          echo "   VPS UBUNTU 20.04 SIAP (LEGACY STABLE)"
          echo "=============================================="
          echo "Host     : ubuntu-datacenter-2004"
          echo "User     : root"
          echo "Pass     : (Sesuai Secrets)"
          echo "Connect  : ssh root@<domain-anda>"
          echo "Status   : ONLINE (Max 6 Jam)"
          echo "=============================================="
          
          # --- Loop Keep-Alive ---
          while true; do 
            sleep 60
            echo "Heartbeat - System Normal - $(date)"
          done
