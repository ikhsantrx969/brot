name: VM TEST (Tailscale)
on: 
  workflow_dispatch:

jobs:
  kvm-mode-on:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. PERSIAPAN KVM (Penting!)
      - name: Siapkan Permission KVM
        run: |
          echo "Setting permission /dev/kvm biar bisa dibaca Docker..."
          sudo chmod 666 /dev/kvm
          ls -la /dev/kvm

      # 2. Login ke GHCR (Biar bisa tarik image custom kamu)
      - name: Login GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
    
      - name: CEK DULU ADA ISINYA KAGAK
        run: |
          if [ -z "${{ secrets.TAILSCALE_AUTHKEY }}" ]; then
            echo "âŒ KOSONG BOS! Secret ga kebaca sama sekali."
            exit 1
          else
            echo "âœ… AMAN! Secret terdeteksi (Panjang karakter: ${#MY_SECRET})"
          fi
        env:
          MY_SECRET: ${{ secrets.TAILSCALE_AUTHKEY }}

      # ... baru langkah tailscale ...
        
      # 3. Connect Tailscale
      - name: Connect Tailscale
        uses: tailscale/github-action@v2

     # ... langkah checkout code ...

      
# 3. Install & Connect Tailscale (CARA MANUAL / HARDCORE)
      - name: Install & Connect Tailscale Manual
        run: |
          # 1. Download & Install
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # 2. Jalanin Daemon (Service) di Background
          # Di GHA kadang service ga auto-start, jadi kita paksa start
          sudo tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          
          # Tunggu bentar biar daemon nyala
          sleep 5
          
          # 3. Login / Connect pake Key
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --ssh --hostname gh-kvm-box
        
      # 4. JALANKAN DOCKER DENGAN KVM ðŸš€
      - name: Start Docker Container (KVM Enabled)
        run: |
          # Konfigurasi
          RAM=7000 # Mentok di 7GB untuk GHA
          CPU=2
          
          echo "Starting Container..."
          
          docker run -d \
            --name my_kvm_machine \
            --device /dev/kvm \
            --privileged \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            -e RAM=$RAM \
            -e CPU=$CPU \
            ghcr.io/ikhsantrx969/ubuntuos:latest \
            /sbin/init
            
            # Catatan: /sbin/init dipakai kalau image kamu support systemd
            # Kalau error, ganti baris terakhir jadi: tail -f /dev/null

      # 5. Keep Alive (6 Jam)
      - name: Tunggu Koneksi Termux
        run: |
          echo "âœ… MESIN KVM SIAP!"
          echo "ðŸ“± Buka Termux -> ssh runner@gh-kvm-box"
          echo "ðŸ’¡ Setelah masuk, ketik: docker exec -it my_kvm_machine bash"
          sleep 21600
